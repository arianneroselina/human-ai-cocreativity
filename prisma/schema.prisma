datasource db {
  provider  = "postgresql"
  url       = env("PRISMA_DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum Workflow {
  human
  ai
  human_ai
  ai_human
}

model Session {
  id                  String           @id @default(cuid())
  totalRounds         Int
  totalPracticeRounds Int
  startedAt           DateTime         @default(now())
  finishedAt          DateTime?
  timeMs              Int?
  rounds              Round[]
  participantId       Int?
  feedback            Feedback?
}

model Round {
  id                 String         @id @default(cuid())
  session            Session        @relation(fields: [sessionId], references: [id])
  sessionId          String
  index              Int
  workflow           Workflow
  taskId             String
  startedAt          DateTime       @default(now())
  submittedAt        DateTime?
  text               String?
  timeMs             Int?
  wordCount          Int?
  charCount          Int?
  passed             Boolean?
  requirementResults Json?
  feedback           RoundFeedback?
  aiChat             AiChat?

  @@unique([sessionId, index])
}

model RoundFeedback {
  id                   String    @id @default(cuid())
  round                Round     @relation(fields: [sessionId, roundIndex], references: [sessionId, index], onDelete: Cascade)
  sessionId            String
  roundIndex           Int
  workflow             Workflow
  taskId               String

  // NASA TLX (21-point)
  mentalDemand         Int?
  physicalDemand       Int?
  temporalDemand       Int?
  performance          Int?
  effort               Int?
  frustration          Int?

  // Likert 1â€“5
  aiUnderstanding      Int?
  aiCollaboration      Int?
  aiCreativitySupport  Int?
  aiPerformanceOverall Int?

  rulesConfidence      Int?
  satisfactionResult   Int?

  comment              String?
  createdAt            DateTime   @default(now())

  @@unique([sessionId, roundIndex])
}

model Feedback {
  id              String   @id @default(cuid())
  session         Session  @relation(fields: [sessionId], references: [id])
  sessionId       String   @unique
  satisfaction    Int?
  clarity         Int?
  effort          Int?
  frustration     Int?
  workflowRanking Workflow[]
  rankingReason   String?
  comments        String?
  createdAt       DateTime @default(now())
}

model AiChat {
  id        String   @id @default(cuid())
  round     Round    @relation(fields: [roundId], references: [id], onDelete: Cascade)
  roundId   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  messages  AiChatMessage[]
}

model AiChatMessage {
  id         String   @id @default(cuid())
  chat       AiChat   @relation(fields: [chatId], references: [id], onDelete: Cascade)
  chatId     String
  role       String   // "user" | "assistant" | "system"
  content    String?
  action     String?  // "select" | "clear" | "seed_with_draft" | "trust_break"
  selected   Boolean  @default(false)
  createdAt  DateTime @default(now())
}
